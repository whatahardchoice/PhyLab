# Phylab 部署文档

## 前言

`v0.1`

此部署文档由2015级团队的部署文档改进而来，目前仍不够完善，主要问题是还未考虑composer安装laravel环境的问题。暂时的解决办法是提供安装好laravel等相关依赖的全量包。

下一阶段将尽量将业务代码和环境代码分离，并更新laravel环境，此文档内容随时可能变更

## 1. 环境要求

Ubuntu 16.04
PHP 7.0

## 2. 部署方法

### 安装LAMP

```shell
sudo apt install apache2
sudo apt install php libapache2-mod-php 
sudo apt install php-mbstring php-bcmath php-gd
sudo apt install mariadb-client mariadb-server
sudo a2enmod rewrite
sudo service apache2 restart
```

### 设置数据库

`sudo mysql`

在mariadb中运行以下指令

```mysql
GRANT ALL PRIVILEGES ON *.* TO 'manager'@'localhost' IDENTIFIED BY 'password' WITH GRANT OPTION;
FLUSH PRIVILEGES;
create database Phylab_db;
use Phylab_db;
source backup.sql;
```

其中，manager为数据库账号，password为数据库密码，可以自行设置
backup.sql是数据库备份文件，目前数据库表头仍未整理完，可以向z@bwis.me咨询索取

之后需要对数据库中wecenter部分进行一些设置

推荐使用phpmyadmin对数据库数据进行增删改查

phpmyadmin安装方式

```
sudo apt install phpmyadmin
sudo ln -s /var/www/phpmyadmin /usr/share/phpmyadmin
```
之后访问http://**ip**/phpmyadmin，用刚刚设置的mysql账号密码登录即可。

需要修改wc_system_setting表中，img_url和upload_url字段，将其中的网址替换为网站部署网址即可。

### Apache2 设置


#### /etc/apache2/apache2.conf 配置

对应部分修改为
```
<Directory /var/www/>
        Options Indexes FollowSymLinks
		AllowOverride ALL
        Require all granted
</Directory>
```

#### /etc/apache2/sites-available/000-default.conf 配置

对应部分修改为
```
DocumentRoot /var/www/
	<Directory /var/www/Phylab>
		Options Indexes FollowSymlinks
		AllowOverride all
		Require all granted
	</Directory>
```


### Phylab和wecenter配置

复制Phylab和wecenter以及根目录的.htaccess到`/var/www/`下，修改权限为777

进入`Phylab`文件夹，复制.env.example文件为.env

    cp .env.example .env

并修改.env文件中的数据库账号和密码，以及最后的SERVER_PAGE为网站主页地址（带结尾斜线'/')

进入`wecenter/system/config`文件夹，修改database.php中的数据库账号和密码


### 安装脚本生成报告环境

#### 安装texlive（目前为2018版本）
```shell
wget https://mirrors.tuna.tsinghua.edu.cn/CTAN/systems/texlive/Images/texlive.iso
sudo mount -o loop texlive.iso /mnt
cd /mnt
sudo apt-get install perl-tk
sudo ./install-tl -gui text
```

安装完成后，根据安装提示，设置环境变量

修改`~/.profile`，在其中添加

    export PATH="$PATH:/usr/local/texlive/2018/bin/x86_64-linux"

并执行`source ~/.profile`

#### 设置python环境

```shell
sudo apt install python3-pip
pip3 install jinja2
pip3 install matplotlib
pip3 install scipy
```

可以通过使用清华pip镜像源（https://pypi.tuna.tsinghua.edu.cn/simple ） 加快安装速度

#### 安装slashbox.sty

从此处下载 [slashbox.sty](http://mirrors.ctan.org/macros/latex/contrib/slashbox/slashbox.sty)

将文件拷贝至`/usr/local/texlive/2018/texmf-dist/tex/latex/local/`目录下，若此文件夹不存在则需要新建此文件夹

之后运行`mktexlsr`刷新tex安装，可以通过

    kpsewhich slashbox.sty

查看安装是否成功，若安装正确则会显示sty文件位置

