# 项目入门介绍

`v1.0`

## 前言

首先，欢迎你来到这里！

本项目已经开发了4届了，项目较为庞大，此文档旨在帮助你入手整个项目，尽量降低入门的门槛，除此之外也提出了一些建议。

项目本身仍存在很多不足之处，之后也会详细介绍。

笔者能力有限，文中可能出现疏漏或错误，还请批评指正。

无论如何我们都希望这一项目能够延续下去，能够帮到低年级的同学们，并且能够在项目质量上有所提升。

再一次感谢每一个贡献者为此项目做出的努力！



## 项目介绍

本项目名为**Phylab**，由2013级的同学发起，经由2014、2015、2016级同学多轮开发及修缮，是一个以北航物理实验课程为基础的，意在帮助同学们学习物理实验的网站。

Phylab的头牌功能是根据用户输入的数据，生成数据处理报告，以帮助大家在实验前后减轻负担。除此之外Phylab目前还包括小工具、设计性实验复习、论坛等功能。为帮助管理者，Phylab在2016级同学的版本中完善了控制台的功能，可以在网页端编辑后台的报告生成脚本及模板。特别需要注意的是项目中的论坛基于一个开源的PHP论坛模块：**wecenter**



### 技术栈

项目后端基于**PHP**的**Laravel**框架开发，这是一款强大的Web框架，也相对庞大。前端结合了Laravel的Blade模板引擎及Bootstrap3、jQuery等常用前端库。项目中的数据处理脚本使用**Python3**（之前为2，已经升级）开发，模板目前支持LaTeX和Markdown两种。数据库采用了传统的MySQL，部署使用了Apache2作为Web服务器。



### GitHub地址

2013：[buaase/Phylab-Web](https://github.com/buaase/Phylab-Web)

2014：[default1406/PhyLab](https://github.com/default1406/PhyLab)

2015：[BUAASigma/PhyLab](https://github.com/BUAASigma/PhyLab)

2016：[whatahardchoice/PhyLab](https://github.com/whatahardchoice/PhyLab)

其中2016级的项目大体基于2014级项目开发，活跃分支为**dev**

### 博客

2013：[软剑攻城](https://www.cnblogs.com/buaase/)

2014：[Default](https://www.cnblogs.com/Default1406/)

2015：[sigma_rg](https://www.cnblogs.com/sigma-rg/)

2016：[WhatAHardChoice](https://www.cnblogs.com/hardchoice/)

## 项目结构

接下来以目前2016级项目的dev分支内容为基础介绍整个项目的结构。

### 根目录

目前项目根目录下有三个文件夹及一个.htaccess文件。

docs文件夹为项目文档，你也可以参考master分支中的Docs文件夹，其中包括了一些往届的项目文档。

Phylab为物理实验网站的主体。wecenter为论坛模块主体。

.htaccess为Apache2的访问控制配置。

.gitignore中为Github忽略的诸多内容，大多为框架安装文件及敏感配置信息。

### Phylab

该文件夹下为实验网站的主体，本质为一Laravel项目。

#### app

该文件夹为后端主要逻辑所在。其中最主要的内容位于**Http**内。Http文件夹中的主要内容为：

- Controllers文件夹，内含所有的后端控制器（MVC中的Controller）
- routes.php，为项目路由，即访问网站的路径和控制器函数的对应关系。
- helper.php，包含了发送修改密码邮件的部分逻辑

##### Controllers中的控制器

- ConsoleController：大部分控制台函数
- Controller：控制器父类，所有的控制器都继承自此类
- DesexpController：设计性实验
- IndexController：主页、公告栏
- ReportController：实验报告生成
- StarController：收藏夹
- ToolsController：小工具（网站上的一个模块）
- UserController：用户管理
- Auth文件夹：用户注册和登陆的相关逻辑。

除此之外，app文件夹下的**Exception**文件夹存有一些自定义的异常，**Models**文件夹存储了数据库中表的相关定义（MVC中的Model），**Providers**文件夹用于引入额外的插件（AppServiceProvider.php可以用于使用IDEHelper，后文会介绍）

其余的文件夹各有其用途，但在开发中涉及较少。

#### bootstrap

这个文件夹是Laravel项目启动所需的内容，一般不会动

#### config

项目配置文件夹，大部分配置文件基于此。当你在代码中看到形如`Config::get('phylab.xxx')`的内容时，get中点前后分别对应config文件夹中的文件名及其中的配置。大部分配置集中在phylab.php中，包括了大部分路径配置。除此之外常用的还有database.php和filesystem.php，但大多已经配置好无需改动。

#### database

这个文件夹看名字是和数据库有关系的，但目前开发并没有用到这个文件夹的内容

#### public

公共资源文件夹，主要的前端资源都集中于此，用户对此文件夹也有直接访问的权限。**但需要注意的是前端html代码并不在此。**

该文件夹下的主要内容包括

- avatar：用户头像
- ckeditor：不知道在哪里使用了的编辑器
- codemirror：控制台使用的代码编辑器
- css：前端样式（不全，很多样式零零散散在HTML代码中了）
- desexp_html：设计性实验使用的静态html
- fonts：字体
- img：图像资源
- js：JavaScript代码
- pdf_tmp：用户生成的pdf和html报告及一些中间文件（如tex文件）均位于此，建议经常清理，因为用户一旦再次生成报告，之前的报告就没用了。
- prepare_pdf：各实验的预习报告
- star_pdf：用户收藏的pdf报告位于此，不要动
- bulletin.html：公告栏内显示的html代码

##### JS文件夹下的代码文件

以下仅介绍目前项目开发主要接触到的几个文件

* bootstrap.min.js：bootstrap动画实现所必须
* bulletin.js：公告栏修改功能
* consoleCore.js：控制台前端功能
* desexp.js：设计性实验前端功能（功能页面，不是设计性实验切换的iframe内文档所使用的js）
* jquery-2.1.4.min.js：jQuery所必须
* linear-regression.js/successive-difference.js：小工具使用的计算模块
* login.js：登陆
* pdfobject.js：貌似是显示pdf使用的插件
* phycacl.js：小工具页面
* regist.js：注册
* reportCore.js：实验报告生成界面功能
* star.js：收藏夹功能
* user.js：用户界面功能
* xmlInteraction.js：将用户输入数据转为xml

#### resources/views

resources文件夹下的主要内容在views文件夹下，这里存储了所有的前端页面，以Blade模板引擎为基础（因此后缀都是.blade.php)，相当于MVC中的View部分。

需要额外注意以下内容

- layout文件夹：其中定义了网站的顶栏，查看其他的模板你会发现在开头均有类似于

  ```
  @extends('layout.main')
  @section('contents')
  ```

  的内容，这里的作用是公用了layout文件夹中的顶栏部分

- report文件夹：这里除了存储实验报告生成的界面外，还存储了每个报告的表格html

当你在代码中看到控制器返回的内容是view(xxx)后，来这里找就对了。

Blade模板引擎强大的地方在于，其可以通过后端的信息返回不同的前端信息，可以在HTML中嵌入类似于`@if, @for`等逻辑来控制前端显示。（当然这基于传统的MVC模式，也有悖于目前火热的前后端分离开发方式。）

#### storage/app

这里存储了和模板生成有关的大部分内容。storage文件下的其他内容暂时没有使用。

app文件夹下存在script和xml_tmp两个文件夹，后者存储了报告生成过程中临时产生的xml文件，可以及时清理。

script文件夹下内容较多

- handler.py & handler_md.py：两类报告生成的主入口，其按照传入的参数分别调用不同的脚本
- pxxxxxxx.py：每个小实验的脚本，注意到部分脚本没有被使用。
- phylab.py：一些之前同学编写的库函数，例如线性回归、生成latex数学公式中的科学记数法等
- template.py：脚本模板，当你在控制台新建实验时会基于此模板。
- PhysicsTest文件夹：设计性实验的md文档。
- tex&markdown文件夹：LaTeX和Markdown模板，均以Handle开头。
- test：一些测试内容及数据
- pres：前人遗留的内容，基本不用

#### tests

这里存储了phpunit的单元测试代码及单元测试报告。运行测试需要在服务器上安装phpunit。可以在public文件夹下建立软链以方便访问codeCoverage中的覆盖率报告。

#### vendor/node_modules等文件夹：

这些文件夹中存有使用composer和npm安装的依赖内容，这些内容理论上不应该被放到GitHub上，而是每次额外安装。

如果你在安装依赖过程中遇到了问题，也可以考虑在往届代码中将这些文件夹的内容下载下来，往往复制进去后就能跑。但笔者强烈不建议将这些内容放到GitHub上，也不建议在本地存有这些代码，否则在同步的时候会非常痛苦。

#### 一些文件

- .env.example：全局配置模板，在部署时你需要将其复制一份并重命名为.env，其中包含了数据库配置、邮件配置等敏感信息，不要传到GitHub上！（前几届都这么干了。。。想想把数据库密码放在公网上就很刺激）
- composer.json&composer.lock：项目依赖，使用composer安装，composer.lock是运行`composer install`后生成的，可以删除，但composer.json必须存在。
- composer.phar：composer二进制文件
- package.json，gulpfile.js：npm使用的node.js依赖安装文件，之前的同学貌似使用了gulp对项目进行打包，但目前我们并没有使用。
- phpunit.xml：phpunit单元测试的配置文件。
- .htaccess：和根目录那个类似，但貌似一定要有。

### wecenter

这是项目使用的wecenter模块内容，由于其体积不大因此整个安装好的wecenter内容被放到了GitHub上，这也是处于一些很无奈的原因。

wecenter是一个类似于知乎的问答社区模块，之前的同学为了给网站增加社区功能，将这一模块引入到项目中，但由于其毕竟是一个独立的项目，存在自己的用户系统、配置信息，因此往届同学对项目还有此模块内容进行了部分魔改，以使其能够和Phylab本身结合。

以下仅简单介绍其中的部分重要目录及文件，关于wecenter这一巨坑将在后文详细叙述。

#### system/config

这里保存了wecenter的部分配置信息，比较重要的是database.php，在其中你需要设置数据库敏感信息。由于没有找到如何使其调用Phylab的.env文件方法，因此这里只能将一个未填写敏感信息的文件上传到GitHub（是的，之前的项目也都把密码放到公网上了）

#### views

这里存放了部分往届同学定制的wecenter界面样式文件



## 关于数据库

项目的数据库采用了传统的MySQL。

由于引入了wecenter，Phylab的几个表与wecenter的众多表被存放在了一起。

Phylab的几个主要的表包括：

- admins：存放了管理员信息，目前需要手动在数据库中增删管理员信息。
- desexps：存放了设计性实验的信息
- reports：存放了实验报告生成的相关信息
- stars：存放了用户收藏夹的相关信息
- users：为一个wc_users视图，存放了用户的相关信息。

wecenter的表均已wc_开头，由于wecenter是一个非常庞大的系统，其数据库的表也非常多。主要需要注意的表是：

- wc_system_setting：这里存放了wecenter的相关配置，实际上不建议在这里直接修改内容，因为其中的内容均已进行了序列化的处理，直接修改时也需要修改内容前的长度信息。后文会简介如何修改wecenter的配置
- wc_users：users视图基于此。



### 关于数据库的部署

往届项目开发中都没有对数据库模式文件做过备份，2015级同学在恢复数据库这一工作上花费了大量时间。但由于整个数据库因wecenter内容而无法直接备份表结构，因此目前我们仍没有做出没有用户数据的表结构文件，仅保存了包含完整用户数据的数据库文件。你可以向：z@bwis.me 索取。

这一问题的根源在于，wecenter实际上也是一个需要安装的项目，但因其源码被魔改过，导致只能将原有项目的wecenter内容直接复制过来，从而安装的步骤被略去。而在安装过程中会建立数据库的相关信息，并且一些表一开始就是非空的（比如刚才提到的wc_system_setting表）。因此无论如何都不能直接将数据库的表头直接导出使用。一种尝试是清空其中所有的用户数据，但由于其散落在很多表中，且wecenter的表数量过多，因此这一步骤也很难完成。



## 关于wecenter

### 一些查找魔改信息的办法

你可以在一些流行的IDE或编辑器中使用全局查找功能搜索：buaaphylab字样，往往能够找到部分被魔改过的函数。

### wecenter和Phylab的关系

总体来说，为了引入wecenter，前人将Phylab的用户数据库改为一个wecenter用户数据库的视图。从而当用户在Phylab端注册（大多情况也只能在此注册）时，后端实际上向wecenter发起了注册的请求。

登陆是被魔改最多的地方。由于Phylab和wecenter的用户系统是分离的，为了实现协同登陆的效果，前人将wecenter的登陆部分进行了魔改。Phylab的登陆系统的自己的，简而言之如果你不进入社区那么也就不会涉及wecenter的登陆问题。当用户尝试进入社区时，wecenter端会通过laravel_session验证用户是否在Phylab端登陆，并以此为据直接进入wecenter或重定向回Phylab登陆界面。因此，wecenter原本的登陆密码便形同虚设了，所有用户在wecenter模块的密码都是一样的，只需要通过laravel_session验证用户是否登录即可。~~这一公共密码由于必须使用，只能直接放在源代码里传到了GitHub上，但笔者在此不透露其具体位置。~~

除此之外，Phylab端的部分功能使用了wecenter的功能。例如邮件认证的功能实际上是完全属于wecenter的，如果你一直不验证邮件，也只能导致无法进入社区。除此之外，实验报告生成界面的评论区实际上是wecenter模块中的文章的评论，因此在数据库的report表内看到related_article字段，实际上是wecenter中的文章id。2016级同学曾在开发中也尝试使用wecenter的头像作为Phylab端头像，后来又改为了单独的头像模块，但这也带来了一些问题，即当在wecenter设置过头像后，在Phylab端会出现错误。

### wecenter的优缺点

优点：

- 管理员界面可以方便的查看用户注册信息，获取用户注册数量等
- 提供了一个功能齐全的社区

缺点：

- 由于其代码被魔改过，升级起来较为困难。
- 大部分功能较为冗余，不够轻量。
- 用户活跃度很低，很低很低，不排除因为2016级软工课开在下半学期，做实验人数较少。但往届的论坛内容也很少。
- 此模块给原Phylab项目的维护也带来了困难，例如上述的数据库问题。

综上所述，wecenter模块初衷是好的，引入社区为大家提供了交流的平台。但由于各种原因这一平台并没有被广泛的使用，其噱头成分更大一些，并且给整体项目的维护带来了一些困难。笔者在此希望之后的同学开发时能够考虑将这一模块精简化或者重构掉，取其精华去其糟粕。

### 如何修改wecenter的配置

首先你需要登陆Phylab，进入社区从而登陆wecenter

然后进入wecenter控制台：`/wecenter/?/admin`

这里的密码不是Phylab端注册时的密码，而藏在了一个特殊的地方，~~你可以通过研究Phylab和wecenter登陆部分的魔改内容找到这一密码的所在地。~~

进入控制台之后就可以随意玩耍了。你可以在控制台的用户管理页看到最近注册的用户。在设置中主要需要配置的内容为发送注册验证邮件的SMTP服务器信息。



## 关于开发环境及部署

笔者并不了解前3届同学的开发方式，因此这里仅介绍笔者团队的开发方式。

由于在项目一开始时，项目中的坑很多，本地迟迟跑不起来，最终我们采用了一台阿里云开发服务器将整个项目运行在其上，并通过**PhpStorm**对项目进行开发。

### PhpStorm的使用

见[PhpStorm使用博客]()

### 本地部署

在整个项目的Gamma阶段，由于一台开发服务器经常出现多人同时开发导致冲突的情况，我们又一次尝试了本地的部署。好在这一次由于大多问题在之前得以解决，本地能够查看项目的大部分前端内容。

具体请见[本地部署踩坑文档]()。

### 协同开发的模式

经过大半个学期的开发后，目前我们认为这一项目的一个可行的开发模式是这样的：

- 开发前端在本地进行，在本地运行浏览器测试前端的效果
- 开发后端在开发服务器进行，使用单元测试和Postman等接口测试工具测试后端的效果
- 最后将开发好的前端部署到开发服务器上进行对接，并进行手动的验收测试
- 发布时利用PhpStorm将所有需要发布的内容更新到发布服务器上，再进行最终的验收测试。

这一模式的确存在一部分缺点，如最终的测试仍需要手动进行，对接过程可能出现诸多问题，且后端开发仍不能避免冲突。但相比于所有人仅用一个开发服务器来说，开发前端的冲突会少很多。

笔者认为，如果项目能以前后端完全分离的方式存在，前端使用Vue、React等框架，后端以Restful API的方式呈现，那么协同开发的难度也会降低一些。

### 全栈开发一个新功能的方式

1. 确定接口，接口要实现的功能是什么，定义好接口的输入输出格式。
2. 写后端，在控制器文件夹中新建一个Controller文件，或在已有的控制器中增加一个新的函数。在routes.php中增加路由。完成后端的主要逻辑。这其中可能出现很多问题，或不知道怎么具体实现，需要大量面向Google/StackOverflow/技术博客编程。
3. 用Postman测试后端，写单元测试。
4. 写前端的界面。看情况是否需要增加新页面，无论如何大概都要修改resource/views文件夹下的前端模板（看起来是Blade模板，其实就是HTML）。可以使用Bootstrap的组件。边写边调整样式，使其符合大概的要求。可以考虑在public/css下修改样式，不推荐之前的在HTML标签里嵌style的写法（虽然方便）
5. 写前端逻辑（JS），在public/js下修改其中的js文件或新增一个js（记得在HTML中引入），此时除了前端一些控制逻辑外，大多需要编写代码向接口发起请求。这其中也可能出现很多问题，或不知道怎么具体实现，也需要大量面向Google/StackOverflow/技术博客编程。
6. 把代码传到开发服务器上，看对接是否出问题，并进行测试。如果有问题先确定问题出在哪，前端用浏览器的控制台调试，后端用Xdebug调试。

在以上过程中如有问题随时记录，也可以记录自己解决问题的方法。

## 目前存在的问题

即使项目已经开发了4届，但项目中的很多问题仍没有完全解决。

- 代码格式不够规范
- 变量、函数以及接口命名随意，由于项目复杂不敢轻易改动。
- 即使删除了很多残留代码，并添加了注释，项目中仍存在一些我们不确定是否启用也不敢改动的内容（函数、接口等等）。
- wecenter和Phylab的结合导致的诸多维护困难，如配置文件不唯一、数据库问题等等
- 各模块版本老旧，且该框架升级比较麻烦：后端方面项目起初选用了Laravel 5.1，为当时最新的LTS版本，配套的PHP为7.0，该Laravel版本马上就要结束支持了，且缺少很多新功能。目前Laravel最新已经更新到了5.8，PHP也更新至了7.3版本。Laravel每一个大版本升级（版本号+0.1）都有一篇单独的文档，如果不是一直跟进的话跨多个版本升级难度很大。前端方面采用的Bootstrap 3也很久没有升级。
- 实验脚本不全，有些实验脚本有bug。开发依赖的百度贴吧内容由于未知的原因被删除（贴吧删除了2017年以前的所有帖子，而开发脚本采用的大部分内容都来源于此），导致开发新脚本难度更大。
- 项目仍有不少小bug，很多方法实现较为tricky，扩展性不强。
- 很多功能没有实现，比如在Phylab端的控制台可管理内容较少，且脚本编写门槛很高。（降低门槛的问题可以另起一个项目了）

## 一些建议

基于以上的问题，笔者包括之前的学长都建议对整个项目进行重构。实际上2016级的另一个团队就是这么做的，他们使用另一个框架将整个项目重写了一遍，当然因此很多功能无法在短时间内都实现完。

重构的缺点非常明显，那就是一旦重构不成功，就和什么也没干差不多。顺着原来的项目开发虽然有时很头疼，但整个项目的积累是看得见摸得着的；重构就是从头开始实现那些本来就有的功能，甚至可能实现不了之前的很多功能。

但实际上这一项目开发到现在，主体的功能都已实现了，继续增加新功能也只是小修小补。重构的一大好处是可以更专注于项目质量方面，并且也可以尝试新的框架、新的技术。项目开始时选一个好的框架（这里的好是多方面的，可以是易于学习，也可以是性能更好，等等），在开始开发时便注意写好注释、写好测试、写好文档，并时刻注意项目的可维护性和可扩展性。从一开始就注意项目的质量，要比之后修补方便的多。

因此基于目前的代码继续开发/修补，还是另起炉灶重造轮子，和每个团队成员的能力、时间安排，以及团队之间的契合程度都脱不开关系。但无论如何尽早开始打算总是好的。

如果打算重构的话，一些可行的方向包括：

- 采取前后端分离的模式，前端使用Vue等纯前端框架构建一个SPA（单页应用，Single Page Application），后端采用RestAPI的方式呈现。这里的一些问题是Restful的无状态特性在部分功能上实现困难（如注册登录，管理员鉴权），但也不是没有办法（例如采用JWT）。
- 采用一个轻量的后端框架：可以考虑基于Go语言的一些框架，或基于NodeJS的一些框架。
- 精简论坛功能，考虑手写一个论坛（或其他的社交功能），而不是采用过于复杂的开源模块。
- 尝试把报告计算的逻辑放到前端来，从而极大减轻后端的工作量。
- 尝试降低编写报告门槛，比如做可视化的脚本编辑，但这一方向的工作量非常大，甚至和目前的Phylab也没什么关系了，可以另起项目。
- （强烈推荐）尝试将前端改成微信小程序，并尝试接入微信用户系统。网页端主要留给后台管理使用。

如果不打算重构的话，以下内容也可以改进：

- 升级Laravel框架及PHP版本，尝试一些新的特性。
- 继续完善测试，特别是自动化的测试。
- 统一代码风格，修改各种乱七八糟的命名。
- 精简wecenter或者去掉wecenter。这部分的难度不小，如果想实现出原来的功能仍需要费不少功夫。
- 把各种事情自动化：持续集成，自动化部署等等。



